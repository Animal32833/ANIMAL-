// Variable global para almacenar el gráfico de progreso
let graficoProgreso;

// Función para calcular la TMB
function calcularTMB(peso, altura, edad, genero) {
    if (genero === 'masculino') {
        return Math.round(88.36 + (13.4 * peso) + (4.8 * altura) - (5.7 * edad));
    } else {
        return Math.round(447.6 + (9.2 * peso) + (3.1 * altura) - (4.3 * edad));
    }
}

// Función para calcular la ingesta de agua recomendada
function calcularIngestaAgua(peso) {
    return (peso * 0.035).toFixed(2); // 35 ml por kg de peso
}

// Base de datos de recetas con restricciones alimenticias y objetivos de nutrición, con acompañamientos
const recetas = [
    // (Ejemplo de recetas)
    { nombre: "Avena con Frutas", calorias: 350, proteinas: 10, carbohidratos: 60, grasas: 5, restricciones: ["sin gluten", "vegetariano"], tipo: "desayuno", objetivos: ["mantener_peso", "ganar_masa"] },
    // (Más recetas...)
];

// Función para generar automáticamente el menú completo del día
function generarMenuAutomatico(caloriasDiarias, restriccionesUsuario, objetivo) {
    const comidasDiarias = ['desayuno', 'almuerzo', 'cena', 'snack'];
    let menuCompleto = `<h3>Menú del día:</h3><ul>`;

    comidasDiarias.forEach(comida => {
        const recetasFiltradas = recetas.filter(receta => {
            const cumpleRestricciones = restriccionesUsuario
                ? receta.restricciones.includes(restriccionesUsuario.toLowerCase())
                : true;
            const cumpleObjetivo = receta.objetivos.includes(objetivo);
            return receta.tipo === comida && cumpleRestricciones && cumpleObjetivo;
        });

        if (recetasFiltradas.length > 0) {
            const recetaSeleccionada = recetasFiltradas[Math.floor(Math.random() * recetasFiltradas.length)];
            menuCompleto += `<li><strong>${comida.charAt(0).toUpperCase() + comida.slice(1)}:</strong> ${recetaSeleccionada.nombre} (${recetaSeleccionada.calorias} calorías)`;
            if (recetaSeleccionada.acompanamiento) {
                menuCompleto += `, acompañado de ${recetaSeleccionada.acompanamiento}`;
            }
            menuCompleto += `</li>`;
        } else {
            menuCompleto += `<li><strong>${comida.charAt(0).toUpperCase() + comida.slice(1)}:</strong> No hay opciones disponibles para tus restricciones.</li>`;
        }
    });

    menuCompleto += `</ul>`;
    return menuCompleto;
}

// Función para manejar el envío del formulario de nutrición
const nutricionForm = document.getElementById("nutricionForm");
if (nutricionForm) {
    nutricionForm.addEventListener("submit", function(event) {
        event.preventDefault();

        // Obtener los datos del formulario
        const nombreField = document.getElementById("nombre");
        const edadField = document.getElementById("edad");
        const pesoField = document.getElementById("peso");
        const alturaField = document.getElementById("altura");
        const generoField = document.getElementById("genero");
        const objetivoField = document.getElementById("objetivo");
        const restriccionesField = document.getElementById("restricciones");

        if (nombreField && edadField && pesoField && alturaField && generoField && objetivoField && restriccionesField) {
            const nombre = nombreField.value;
            const edad = edadField.value;
            const peso = pesoField.value;
            const altura = alturaField.value;
            const genero = generoField.value;
            const objetivo = objetivoField.value;
            const restricciones = restriccionesField.value;

            // Calcular BMR (Tasa Metabólica Basal)
            const bmr = calcularTMB(peso, altura, edad, genero);

            // Calcular las calorías diarias dependiendo del objetivo
            let caloriasDiarias;
            if (objetivo === "perder_peso") {
                caloriasDiarias = bmr * 1.2 - 500;
            } else if (objetivo === "ganar_masa") {
                caloriasDiarias = bmr * 1.5 + 300;
            } else {
                caloriasDiarias = bmr * 1.2;
            }

            // Mostrar el consumo de agua recomendado
            const ingestaAgua = calcularIngestaAgua(peso);
            console.log(`Tu TMB es ${bmr} kcal.`);
            console.log(`Te recomendamos beber ${ingestaAgua} litros de agua al día.`);
            
            const resultadoAgua = document.getElementById("resultadoAgua");
            if (resultadoAgua) {
                resultadoAgua.textContent = `Te recomendamos beber ${ingestaAgua} litros de agua al día.`;
            }

            // Generar el menú automáticamente
            const menuGenerado = generarMenuAutomatico(caloriasDiarias, restricciones, objetivo);
            const resultadoDieta = document.getElementById("resultadoDieta");
            if (resultadoDieta) {
                resultadoDieta.innerHTML = menuGenerado;
            }
        } else {
            console.error("Algunos de los campos del formulario no se encontraron en el DOM.");
        }
    });
}

// Función para manejar el envío del formulario de progreso y guardarlo en localStorage
const progresoForm = document.getElementById("progresoForm");
if (progresoForm) {
    progresoForm.addEventListener("submit", function(event) {
        event.preventDefault();

        const dni = document.getElementById("dni").value;
        const peso = document.getElementById("peso").value;
        const medidaCintura = document.getElementById("medidaCintura").value;
        const medidaCadera = document.getElementById("medidaCadera").value;

        // Guardar el progreso en el localStorage, usando el DNI como clave
        const progresoUsuario = {
            peso: peso,
            medidaCintura: medidaCintura,
            medidaCadera: medidaCadera,
            fecha: new Date().toLocaleDateString() // Fecha del registro
        };

        let progresos = JSON.parse(localStorage.getItem(dni)) || [];
        progresos.push(progresoUsuario);
        localStorage.setItem(dni, JSON.stringify(progresos));

        // Mostrar el progreso en el gráfico
        mostrarGraficoProgreso(dni);
    });
}

// Función para cargar y mostrar el gráfico de progreso del usuario
function mostrarGraficoProgreso(dni) {
    const progresos = JSON.parse(localStorage.getItem(dni)) || [];

    const datosProgreso = {
        labels: progresos.map((progreso, index) => `Registro ${index + 1}`),
        datasets: [{
            label: 'Peso (kg)',
            data: progresos.map(progreso => progreso.peso),
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2
        }]
    };

    if (graficoProgreso) {
        graficoProgreso.destroy();
    }

    const ctx = document.getElementById('graficoProgreso');
    if (ctx) {
        graficoProgreso = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: datosProgreso,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }
}

// Función para cargar el progreso del usuario al ingresar el DNI
const cargarProgresoForm = document.getElementById("cargarProgresoForm");
if (cargarProgresoForm) {
    cargarProgresoForm.addEventListener("submit", function(event) {
        event.preventDefault();
        const dni = document.getElementById("dniCargar").value;
        mostrarGraficoProgreso(dni);
    });
}
